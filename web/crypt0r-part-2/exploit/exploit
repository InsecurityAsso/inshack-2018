#!/usr/bin/env python2.7
# encoding: utf-8

# deactivating, don't want to setup a tor proy just for a challenge :p
# Moreover, looks like onion.to is not really stable
exit(0)

import hlextend
import base64
import requests

# url = "http://localhost"
url = "https://kx4hdh2zo5rstcuj.onion.to/"

r = requests.get(url)
salt, h, data = r.cookies["user"].split(":")
data = base64.urlsafe_b64decode(data)

sha = hlextend.new('sha256')

toinject = 'xxx: xxx\ninsa_coins: 500\n'

res = sha.extend(toinject, salt + data, 20, h, raw=True)
res = res[len(salt):]

new_cookie = salt + ":" + sha.hexdigest() + ":" + base64.urlsafe_b64encode(res)
resp = requests.post(url + "/pay?offer=premium&cost=500", cookies={"user": new_cookie}, data='')

if "INSA{" in resp.text:
    print resp.text
    print "OK!"
    exit(0)

print resp.status_code
print len(resp.content)
print resp.text
exit(1)
